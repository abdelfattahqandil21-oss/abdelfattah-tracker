<app-header></app-header>

<div class="max-w-6xl mx-auto px-4 py-8">
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-3xl font-bold font-display text-primary">Sugar Tracker</h1>
    <div class="text-sm text-text-muted font-body">Track your glucose levels</div>
  </div>

  @if (isLoading()) {
  <app-loading-spinner [fullScreen]="false" message="Loading Entries..." />
  } @else {
  <!-- Add Entry Card -->
  <div
    class="bg-bg-card p-6 rounded-xl shadow-sm border border-border mb-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
    <h2 class="text-lg font-bold font-display text-text-main mb-4">New Reading</h2>
    <div class="flex flex-col md:flex-row gap-4 items-end flex-wrap">
      <div class="w-full md:w-auto flex-1">
        <label class="block text-xs font-bold text-text-muted uppercase tracking-wider mb-1">Date</label>
        <input type="date" [ngModel]="today()" (ngModelChange)="today.set($event)"
          class="w-full p-2 border border-border rounded bg-bg-input text-text-main focus:border-primary outline-none transition-colors" />
      </div>

      <div class="w-full md:w-auto flex-1">
        <label class="block text-xs font-bold text-text-muted uppercase tracking-wider mb-1">Meal</label>
        <select #mealSelect
          class="w-full p-2 border border-border rounded bg-bg-input text-text-main focus:border-primary outline-none transition-colors">
          <option value="breakfast">Breakfast</option>
          <option value="lunch">Lunch</option>
          <option value="dinner">Dinner</option>
        </select>
      </div>

      <div class="w-full md:w-auto flex-1">
        <label class="block text-xs font-bold text-text-muted uppercase tracking-wider mb-1">Timing</label>
        <select #timingSelect
          class="w-full p-2 border border-border rounded bg-bg-input text-text-main focus:border-primary outline-none transition-colors">
          <option value="before">Before Meal</option>
          <option value="after">After Meal (2hrs)</option>
        </select>
      </div>

      <div class="w-full md:w-auto flex-1">
        <label class="block text-xs font-bold text-text-muted uppercase tracking-wider mb-1">Value (mg/dL)</label>
        <input type="number" #valueInput placeholder="Enter value"
          class="w-full p-2 border border-border rounded bg-bg-input text-text-main focus:border-primary outline-none transition-colors" />
      </div>

      <button
        (click)="addEntryWithValue(today(), $any(mealSelect).value, $any(timingSelect).value, +valueInput.value); valueInput.value = ''"
        class="w-full md:w-auto bg-primary text-text-inverse px-6 py-2 rounded hover:bg-primary-dark transition-colors font-bold uppercase tracking-wider h-[42px]">
        Add Entry
      </button>
    </div>
  </div>

  <!-- Last 14 Days Table -->
  <div class="animate-in fade-in slide-in-from-bottom-4 duration-500 delay-100">
    <h2 class="text-xl font-bold font-display text-primary mb-6">Last 14 Days History</h2>
    <div class="bg-bg-card rounded-xl shadow-sm border border-border overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-center border-collapse">
          <thead>
            <!-- First header row: Date + Meal names -->
            <tr class="bg-bg-app border-b border-border">
              <th rowspan="2"
                class="p-4 font-bold text-text-muted uppercase tracking-wider text-xs border-r border-border align-middle">
                Date</th>
              <th colspan="2"
                class="p-3 font-bold text-primary uppercase tracking-wider text-xs border-r border-border">Breakfast
              </th>
              <th colspan="2"
                class="p-3 font-bold text-primary uppercase tracking-wider text-xs border-r border-border">Lunch</th>
              <th colspan="2" class="p-3 font-bold text-primary uppercase tracking-wider text-xs">Dinner</th>
            </tr>
            <!-- Second header row: Before/After for each meal -->
            <tr class="bg-bg-app border-b border-border">
              <th class="p-2 font-medium text-text-muted text-xs border-r border-border/50">Before</th>
              <th class="p-2 font-medium text-text-muted text-xs border-r border-border">After 2hrs</th>
              <th class="p-2 font-medium text-text-muted text-xs border-r border-border/50">Before</th>
              <th class="p-2 font-medium text-text-muted text-xs border-r border-border">After 2hrs</th>
              <th class="p-2 font-medium text-text-muted text-xs border-r border-border/50">Before</th>
              <th class="p-2 font-medium text-text-muted text-xs">After 2hrs</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of groupedByDate()" class="border-b border-border hover:bg-bg-app transition-colors">
              <td class="p-4 text-text-main font-medium border-r border-border">
                <div class="font-bold">{{ row.date | date:'EEE' }}</div>
                <div class="text-sm text-text-muted">{{ row.date | date:'MMM d' }}</div>
              </td>
              <td class="p-3 font-bold border-r border-border/50" [ngClass]="getValueColor(row.breakfastBefore)">
                {{ row.breakfastBefore || '---' }}
              </td>
              <td class="p-3 font-bold border-r border-border" [ngClass]="getValueColor(row.breakfastAfter)">
                {{ row.breakfastAfter || '---' }}
              </td>
              <td class="p-3 font-bold border-r border-border/50" [ngClass]="getValueColor(row.lunchBefore)">
                {{ row.lunchBefore || '---' }}
              </td>
              <td class="p-3 font-bold border-r border-border" [ngClass]="getValueColor(row.lunchAfter)">
                {{ row.lunchAfter || '---' }}
              </td>
              <td class="p-3 font-bold border-r border-border/50" [ngClass]="getValueColor(row.dinnerBefore)">
                {{ row.dinnerBefore || '---' }}
              </td>
              <td class="p-3 font-bold" [ngClass]="getValueColor(row.dinnerAfter)">
                {{ row.dinnerAfter || '---' }}
              </td>
            </tr>
            <tr *ngIf="groupedByDate().length === 0">
              <td colspan="7" class="p-8 text-center text-text-muted">No data for the last 14 days</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  }
</div>